# Система друзей и пользователей

## Обзор архитектуры

Система спроектирована для удобного создания счетов с участием друзей, которые могут быть как зарегистрированными пользователями, так и гостями.

## Основные компоненты

### 1. Таблица `User`

Основная таблица пользователей, связанная с Telegram:

- `id` - уникальный ID пользователя
- `telegramUserId` - ID пользователя в Telegram
- `username` - @username в Telegram
- `firstName` - имя пользователя
- `friends` - связь с таблицей друзей

### 2. Таблица `Friend`

Локальный список друзей каждого пользователя:

- `id` - уникальный ID друга
- `ownerId` - ID владельца списка друзей
- `name` - имя друга
- `telegramUsername` - @username в Telegram (опционально)
- `telegramUserId` - ID в Telegram (если известен)

### 3. Таблица `BillParticipant`

Участники счетов с поддержкой как зарегистрированных, так и незарегистрированных пользователей:

- `userId` - ссылка на зарегистрированного пользователя (может быть null)
- `telegramUserId` - ID в Telegram
- `telegramUsername` - @username для поиска пользователя
- `name` - отображаемое имя

## Логика работы

### Создание счета

1. Пользователь выбирает друзей из своего списка
2. Система создает участников счета:
   - Если друг зарегистрирован (есть `telegramUserId`) - привязываем к `User`
   - Если нет - создаем участника только с `telegramUsername`

### Автоматическая привязка при входе

При входе пользователя в систему:

1. Автоматически создается/обновляется `User`
2. Система ищет счета, где этот пользователь указан как участник
3. Автоматически привязывает счета к пользователю по `telegramUserId` или `telegramUsername`

## API эндпоинты

### Управление друзьями

- `GET /api/friends` - получить список друзей
- `POST /api/friends` - добавить нового друга
- `PUT /api/friends/:id` - обновить друга
- `DELETE /api/friends/:id` - удалить друга
- `GET /api/friends/search/:username` - найти пользователя по username

### Создание счетов

Обновленный формат участников:

```json
{
  "participants": [
    {
      "name": "Алексей",
      "telegramUsername": "alexey_crypto",
      "shareAmount": "33.33"
    },
    {
      "name": "Мария",
      "telegramUserId": "123456789",
      "shareAmount": "33.33"
    }
  ]
}
```

## Преимущества архитектуры

1. **Гибкость**: Можно создавать счета с участием незарегистрированных пользователей
2. **Удобство**: Локальный список друзей для быстрого выбора
3. **Автоматизация**: Автоматическая привязка счетов при регистрации
4. **Масштабируемость**: Легко добавлять новых участников без регистрации

## Примеры использования

### Сценарий 1: Создание счета с друзьями

1. Пользователь создает список друзей
2. При создании счета выбирает друзей из списка
3. Система автоматически подставляет их данные

### Сценарий 2: Регистрация участника

1. Участник получает ссылку на счет
2. При первом входе автоматически создается аккаунт
3. Все его счета автоматически привязываются к аккаунту

### Сценарий 3: Повторное использование друзей

1. При создании нового счета система предлагает друзей из предыдущих счетов
2. Пользователь может быстро выбрать часто используемых друзей
