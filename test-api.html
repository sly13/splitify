<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Split Bill - API Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px 0;
        font-family: inherit;
      }
      textarea {
        height: 100px;
        resize: vertical;
      }
      .form-group {
        margin: 15px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Crypto Split Bill API Test</h1>

      <div class="test-section">
        <h3>üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞</h3>
        <button onclick="testHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /health</button>
        <div id="health-result" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üë§ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
        <p><strong>Telegram User ID:</strong> 123456789</p>
        <p><strong>Username:</strong> test_user</p>
        <p><strong>Name:</strong> –¢–µ—Å—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
        <div class="info result">
          <strong>InitData –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ X-Telegram-Init-Data:</strong>
          user=%7B%22id%22%3A123456789%2C%22first_name%22%3A%22%D0%A2%D0%B5%D1%81%D1%82%22%2C%22last_name%22%3A%22%D0%9F%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%22%2C%22username%22%3A%22test_user%22%2C%22language_code%22%3A%22ru%22%7D&auth_date=1758191773&hash=fe8e01906856514463efc52a5d4c0a65ab0e4155b4c08b9146f67a78f9a243fd
        </div>
      </div>

      <div class="test-section">
        <h3>üí∞ –°–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç</h3>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞:</label>
          <input
            type="text"
            id="bill-title"
            value="–¢–µ—Å—Ç–æ–≤—ã–π —Å—á–µ—Ç"
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞"
          />
        </div>
        <div class="form-group">
          <label>–û–±—â–∞—è —Å—É–º–º–∞:</label>
          <input
            type="text"
            id="bill-amount"
            value="100.00"
            placeholder="100.00"
          />
        </div>
        <div class="form-group">
          <label>–í–∞–ª—é—Ç–∞:</label>
          <select id="bill-currency">
            <option value="USDT">USDT</option>
            <option value="TON">TON</option>
          </select>
        </div>
        <div class="form-group">
          <label>–¢–∏–ø —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:</label>
          <select id="bill-split">
            <option value="equal">–†–∞–≤–Ω—ã–µ –¥–æ–ª–∏</option>
            <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–æ–ª–∏</option>
          </select>
        </div>
        <div class="form-group">
          <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (JSON):</label>
          <textarea id="bill-participants">
[
  {
    "telegramUserId": "123456789",
    "name": "–¢–µ—Å—Ç"
  },
  {
    "name": "–î—Ä—É–≥–æ–π —É—á–∞—Å—Ç–Ω–∏–∫"
  },
  {
    "name": "–¢—Ä–µ—Ç–∏–π —É—á–∞—Å—Ç–Ω–∏–∫"
  }
]</textarea
          >
          <small style="color: #666"
            >üí° –î–ª—è —Ç–∏–ø–∞ "equal" shareAmount –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è. –î–ª—è
            "custom" —É–∫–∞–∂–∏—Ç–µ shareAmount –≤—Ä—É—á–Ω—É—é.</small
          >
        </div>
        <button onclick="createBill()">–°–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç</button>
        <div id="create-result" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üìã –ü–æ–ª—É—á–∏—Ç—å —Å—á–µ—Ç</h3>
        <div class="form-group">
          <label>ID —Å—á–µ—Ç–∞:</label>
          <input type="text" id="bill-id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å—á–µ—Ç–∞" />
        </div>
        <button onclick="getBill()">–ü–æ–ª—É—á–∏—Ç—å —Å—á–µ—Ç</button>
        <div id="get-result" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>üí≥ –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂</h3>
        <div class="form-group">
          <label>ID —Å—á–µ—Ç–∞:</label>
          <input
            type="text"
            id="payment-bill-id"
            placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å—á–µ—Ç–∞"
          />
        </div>
        <button onclick="createPayment()">–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂</button>
        <div id="payment-result" class="result" style="display: none"></div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:4041";
      const INIT_DATA =
        "user=%7B%22id%22%3A123456789%2C%22first_name%22%3A%22%D0%A2%D0%B5%D1%81%D1%82%22%2C%22last_name%22%3A%22%D0%9F%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%22%2C%22username%22%3A%22test_user%22%2C%22language_code%22%3A%22ru%22%7D&auth_date=1758191773&hash=fe8e01906856514463efc52a5d4c0a65ab0e4155b4c08b9146f67a78f9a243fd";

      function showResult(elementId, data, isError = false) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.className = `result ${isError ? "error" : "success"}`;
        element.textContent =
          typeof data === "string" ? data : JSON.stringify(data, null, 2);
      }

      async function testHealth() {
        try {
          const response = await fetch(`${API_BASE}/health`);
          const data = await response.json();
          showResult("health-result", data);
        } catch (error) {
          showResult("health-result", `–û—à–∏–±–∫–∞: ${error.message}`, true);
        }
      }

      async function createBill() {
        try {
          const title = document.getElementById("bill-title").value;
          const amount = document.getElementById("bill-amount").value;
          const currency = document.getElementById("bill-currency").value;
          const splitType = document.getElementById("bill-split").value;
          const participantsText =
            document.getElementById("bill-participants").value;

          let participants;
          try {
            participants = JSON.parse(participantsText);
          } catch (e) {
            throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö");
          }

          const response = await fetch(`${API_BASE}/api/bills`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Telegram-Init-Data": INIT_DATA,
            },
            body: JSON.stringify({
              title,
              totalAmount: amount,
              currency,
              splitType,
              participants,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showResult("create-result", data);
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º ID –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
            document.getElementById("bill-id").value = data.id;
            document.getElementById("payment-bill-id").value = data.id;
          } else {
            showResult("create-result", data, true);
          }
        } catch (error) {
          showResult("create-result", `–û—à–∏–±–∫–∞: ${error.message}`, true);
        }
      }

      async function getBill() {
        try {
          const billId = document.getElementById("bill-id").value;
          if (!billId) {
            throw new Error("–í–≤–µ–¥–∏—Ç–µ ID —Å—á–µ—Ç–∞");
          }

          const response = await fetch(`${API_BASE}/api/bills/${billId}`, {
            headers: {
              "X-Telegram-Init-Data": INIT_DATA,
            },
          });

          const data = await response.json();

          if (response.ok) {
            showResult("get-result", data);
          } else {
            showResult("get-result", data, true);
          }
        } catch (error) {
          showResult("get-result", `–û—à–∏–±–∫–∞: ${error.message}`, true);
        }
      }

      async function createPayment() {
        try {
          const billId = document.getElementById("payment-bill-id").value;
          if (!billId) {
            throw new Error("–í–≤–µ–¥–∏—Ç–µ ID —Å—á–µ—Ç–∞");
          }

          const response = await fetch(`${API_BASE}/api/payments/intent`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Telegram-Init-Data": INIT_DATA,
            },
            body: JSON.stringify({
              billId,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showResult("payment-result", data);
          } else {
            showResult("payment-result", data, true);
          }
        } catch (error) {
          showResult("payment-result", `–û—à–∏–±–∫–∞: ${error.message}`, true);
        }
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.onload = function () {
        testHealth();
      };
    </script>
  </body>
</html>
